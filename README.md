# Stochastic Weight Averaging (SWA)

This repository is the unofficial implementation of [Averaging Weights Leads to Wider Optima and Better Generalization](https://arxiv.org/abs/1803.05407) (UAI 2018).
The official code can be found [here](https://github.com/timgaripov/swa).

## Command Lines

This projet is built on [giung2-jax](https://github.com/cs-giung/giung2-jax).
```
ln -s /path/to/giung2-jax/giung2 ./
ln -s /path/to/giung2-jax/datasets ./
```

### Train Models

Run the following command lines to train models with SWA:
```
python scripts/train_swa.py \
    --config_file ./configs/{DATASET_NAME}_{NETWORK_NAME}.yaml \
    --num_epochs {EPOCH} --num_warmup_epochs 5 \
    --batch_size 128 --learning_rate 0.1 --weight_decay 5e-4 \
    --swa_num_pt_epochs {PRETRAIN_EPOCH} --swa_learning_rate {SWA_LR} \
    --seed 42 --output_dir ./outputs/{DATASET_NAME}_{NETWORK_NAME}/SWA/e{EPOCH}_pt{PRETRAIN_EPOCH}_lr{SWA_LR}_s42
```

The following figure depicts the learning rate schedule when we use `learning_rate=0.1`, `num_epochs=200`, `num_warmup_epochs=5`, `swa_num_pt_epochs=150`, and `swa_learning_rate=0.05`.
SWA averages parameters at every epoch from 151 to 200 epochs.

![](./figures/lr_schedule.png)

### Evaluate Models

Run the following command lines to evaluate models:
```
python scripts/eval_swa.py \
    --config_file ./configs/{DATASET_NAME}_{NETWORK_NAME}.yaml \
    --weight_file ./outputs/path/to/best_acc1
```

## Results

Refer to [`scripts/logs/README.md`](./scripts/logs/README.md) to view full results of the experiments.

### CIFAR-10 (R20-BN-ReLU)
| Epoch | Pretrain Epoch | SWA LR | Train ACC / NLL / cNLL | Valid ACC / NLL / cNLL | Test ACC / NLL / cNLL  |
| :-:   | :-:            | :-:    | :-:                    | :-:                    | :-:                    |
| 200   | 200            | -      | 99.91 / 0.007 / 0.031  | 92.98 / 0.272 / 0.224  | 92.49 / 0.274 / 0.229  |
|       | 180            | 0.02   | 98.84 / 0.041 / 0.056  | 93.84 / 0.208 / 0.198  | 92.86 / 0.223 / 0.212  |
|       | 150            | 0.02   | 99.00 / 0.037 / 0.054  | 93.72 / 0.211 / 0.199  | 92.97 / 0.215 / 0.204  |
|       | 120            | 0.02   | 98.78 / 0.043 / 0.059  | 93.18 / 0.213 / 0.204  | 92.59 / 0.230 / 0.218  |
|       | 100            | 0.02   | 98.79 / 0.043 / 0.058  | 93.34 / 0.210 / 0.200  | 92.75 / 0.228 / 0.216  |
| 400   | 400            | -      | 99.98 / 0.004 / 0.022  | 93.34 / 0.266 / 0.220  | 92.79 / 0.273 / 0.228  |
|       | 360            | 0.02   | 99.28 / 0.029 / 0.043  | 93.84 / 0.196 / 0.187  | 93.23 / 0.212 / 0.200  |
|       | 300            | 0.02   | 99.24 / 0.030 / 0.045  | 93.78 / 0.201 / 0.191  | 93.08 / 0.211 / 0.200  |
|       | 240            | 0.02   | 99.25 / 0.031 / 0.045  | 93.72 / 0.201 / 0.190  | 93.23 / 0.220 / 0.207  |
|       | 200            | 0.02   | 99.16 / 0.033 / 0.048  | 93.70 / 0.204 / 0.193  | 93.00 / 0.217 / 0.204  |
| 600   | 600            | -      | 99.98 / 0.003 / 0.020  | 93.56 / 0.259 / 0.214  | 92.55 / 0.284 / 0.235  |
|       | 540            | 0.02   | 99.38 / 0.026 / 0.041  | 94.12 / 0.200 / 0.188  | 93.32 / 0.212 / 0.199  |
|       | 450            | 0.02   | 99.38 / 0.027 / 0.041  | 93.82 / 0.201 / 0.191  | 93.57 / 0.211 / 0.199  |
|       | 360            | 0.02   | 99.34 / 0.026 / 0.043  | 93.98 / 0.203 / 0.189  | 93.27 / 0.213 / 0.201  |
|       | 300            | 0.02   | 99.35 / 0.028 / 0.041  | 93.80 / 0.188 / 0.180  | 93.66 / 0.199 / 0.191  |

### CIFAR-100 (R20-BN-ReLU)
| Epoch | Pretrain Epoch | SWA LR | Train ACC / NLL / cNLL | Valid ACC / NLL / cNLL | Test ACC / NLL / cNLL  |
| :-:   | :-:            | :-:    | :-:                    | :-:                    | :-:                    |
| 200   | 200            | -      | 92.42 / 0.274 / 0.385  | 68.84 / 1.210 / 1.121  | 68.22 / 1.228 / 1.136  |
|       | 180            | 0.02   | 86.45 / 0.454 / 0.510  | 69.64 / 1.086 / 1.053  | 69.64 / 1.080 / 1.049  |
|       | 150            | 0.02   | 86.91 / 0.442 / 0.502  | 69.64 / 1.093 / 1.059  | 69.36 / 1.074 / 1.045  |
|       | 120            | 0.02   | 86.13 / 0.463 / 0.522  | 69.26 / 1.104 / 1.068  | 69.40 / 1.087 / 1.056  |
|       | 100            | 0.02   | 85.79 / 0.476 / 0.531  | 69.40 / 1.101 / 1.069  | 69.02 / 1.096 / 1.064  |
| 400   | 400            | -      | 95.70 / 0.175 / 0.306  | 68.40 / 1.270 / 1.144  | 68.15 / 1.276 / 1.147  |
|       | 360            | 0.02   | 88.33 / 0.395 / 0.462  | 70.36 / 1.084 / 1.041  | 70.40 / 1.065 / 1.028  |
|       | 300            | 0.02   | 88.48 / 0.392 / 0.454  | 70.42 / 1.068 / 1.031  | 70.36 / 1.052 / 1.019  |
|       | 240            | 0.02   | 87.04 / 0.431 / 0.493  | 69.20 / 1.091 / 1.054  | 69.89 / 1.089 / 1.055  |
|       | 200            | 0.02   | 87.57 / 0.418 / 0.472  | 70.70 / 1.047 / 1.017  | 69.88 / 1.069 / 1.036  |
| 600   | 600            | -      | 96.97 / 0.136 / 0.275  | 67.82 / 1.315 / 1.166  | 68.04 / 1.313 / 1.163  |
|       | 540            | 0.02   | 89.14 / 0.373 / 0.440  | 70.80 / 1.071 / 1.029  | 70.38 / 1.065 / 1.028  |
|       | 450            | 0.02   | 88.89 / 0.380 / 0.444  | 70.24 / 1.076 / 1.038  | 70.78 / 1.043 / 1.013  |
|       | 360            | 0.02   | 88.83 / 0.383 / 0.443  | 70.78 / 1.057 / 1.024  | 70.50 / 1.061 / 1.026  |
|       | 300            | 0.02   | 88.81 / 0.382 / 0.443  | 70.98 / 1.058 / 1.022  | 70.53 / 1.052 / 1.018  |

### CIFAR-10 (WRN28x10-BN-ReLU)
| Epoch | Pretrain Epoch | SWA LR | Train ACC / NLL / cNLL | Valid ACC / NLL / cNLL | Test ACC / NLL / cNLL  |
| :-:   | :-:            | :-:    | :-:                    | :-:                    | :-:                    |
| 200   | 200            | -      | 100.0 / 0.000 / 0.010  | 96.18 / 0.177 / 0.146  | 96.08 / 0.170 / 0.142  |
|       | 180            | 0.05   | 99.89 / 0.006 / 0.011  | 96.52 / 0.112 / 0.107  | 96.22 / 0.125 / 0.118  |
|       | 150            | 0.05   | 99.88 / 0.007 / 0.012  | 96.56 / 0.113 / 0.108  | 96.12 / 0.120 / 0.114  |
|       | 120            | 0.05   | 99.90 / 0.006 / 0.012  | 96.48 / 0.114 / 0.108  | 96.14 / 0.118 / 0.112  |
|       | 100            | 0.05   | 99.90 / 0.007 / 0.012  | 96.60 / 0.110 / 0.105  | 96.24 / 0.117 / 0.111  |
| 300   | 300            | -      | 100.0 / 0.001 / 0.011  | 96.32 / 0.168 / 0.143  | 96.40 / 0.163 / 0.140  |
|       | 270            | 0.05   | 99.90 / 0.006 / 0.011  | 96.40 / 0.112 / 0.106  | 96.35 / 0.118 / 0.112  |
|       | 225            | 0.05   | 99.91 / 0.006 / 0.011  | 96.66 / 0.110 / 0.104  | 96.19 / 0.119 / 0.114  |
|       | 180            | 0.05   | 99.91 / 0.005 / 0.011  | 96.72 / 0.110 / 0.104  | 96.30 / 0.119 / 0.112  |
|       | 150            | 0.05   | 99.91 / 0.006 / 0.011  | 96.74 / 0.111 / 0.104  | 96.12 / 0.119 / 0.112  |

### CIFAR-100 (WRN28x10-BN-ReLU)
| Epoch | Pretrain Epoch | SWA LR | Train ACC / NLL / cNLL | Valid ACC / NLL / cNLL | Test ACC / NLL / cNLL  |
| :-:   | :-:            | :-:    | :-:                    | :-:                    | :-:                    |
| 200   | 200            | -      | 99.98 / 0.001 / 0.004  | 80.04 / 0.900 / 0.844  | 80.63 / 0.843 / 0.802  |
|       | 180            | 0.05   | 99.68 / 0.011 / 0.026  | 80.62 / 0.803 / 0.679  | 81.08 / 0.785 / 0.669  |
|       | 150            | 0.05   | 99.68 / 0.012 / 0.028  | 81.60 / 0.806 / 0.672  | 81.49 / 0.777 / 0.659  |
|       | 120            | 0.05   | 99.60 / 0.013 / 0.031  | 81.06 / 0.796 / 0.673  | 81.29 / 0.769 / 0.656  |
|       | 100            | 0.05   | 99.43 / 0.018 / 0.038  | 81.12 / 0.775 / 0.665  | 81.24 / 0.759 / 0.658  |
| 300   | 300            | -      | 99.99 / 0.001 / 0.003  | 80.40 / 0.878 / 0.842  | 80.38 / 0.861 / 0.830  |
|       | 270            | 0.05   | 99.78 / 0.008 / 0.020  | 81.02 / 0.805 / 0.676  | 81.44 / 0.791 / 0.667  |
|       | 225            | 0.05   | 99.78 / 0.008 / 0.022  | 81.30 / 0.815 / 0.677  | 81.86 / 0.777 / 0.656  |
|       | 180            | 0.05   | 99.68 / 0.010 / 0.024  | 81.02 / 0.807 / 0.671  | 81.57 / 0.792 / 0.664  |
|       | 150            | 0.05   | 99.66 / 0.011 / 0.028  | 81.66 / 0.801 / 0.670  | 81.39 / 0.776 / 0.658  |

### TinyImageNet-200 (R18-BN-ReLU)
| Epoch | Pretrain Epoch | SWA LR | Train ACC / NLL / cNLL | Valid ACC / NLL / cNLL | Test ACC / NLL / cNLL  |
| :-:   | :-:            | :-:    | :-:                    | :-:                    | :-:                    |
| 100   | 100            | -      | 99.98 / 0.005 / 0.022  | 66.07 / 1.544 / 1.459  | 65.52 / 1.581 / 1.486  |
| 200   | 200            | -      | 99.98 / 0.002 / 0.007  | 66.57 / 1.529 / 1.489  | 65.12 / 1.585 / 1.535  |
| 400   | 400            | -      | 99.98 / 0.001 / 0.002  | 66.52 / 1.562 / 1.555  | 65.95 / 1.593 / 1.583  |

## License

[The MIT License](./LICENSE).
